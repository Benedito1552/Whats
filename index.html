<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SISTEMA BENEDITO JR</title>
<style>
body { font-family: Arial, sans-serif; margin:0; background:#f2f2f2; }
header { background:#075E54; color:white; padding:10px; display:flex; justify-content:space-between; align-items:center; }
header button { background:#128C7E; color:white; border:none; padding:8px 12px; border-radius:5px; cursor:pointer; }
#login-container, #chat-container { display:none; padding:20px; }
input, select, button { padding:10px; margin:5px 0; width:60%; border:1px solid #ccc; border-radius:5px; }
button { background:#128C7E; color:white; cursor:pointer; }
#userList { margin-top:10px; border-top:1px solid #ccc; }
.user { background:white; padding:10px; border-bottom:1px solid #ddd; cursor:pointer; position:relative; }
.user:hover { background:#eaeaea; }
.badge { position:absolute; right:10px; top:12px; background:green; color:white; padding:3px 7px; border-radius:50%; font-size:12px; display:none; }
#chatModal { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); display:none; justify-content:center; align-items:center; }
#chatBox { background:white; width:90%; max-width:400px; height:80%; border-radius:10px; display:flex; flex-direction:column; }
#messages { flex:1; padding:10px; overflow-y:auto; }
.msg { margin:5px 0; padding:8px; border-radius:10px; max-width:80%; word-wrap:break-word; }
.sent { background:#dcf8c6; align-self:flex-end; }
.received { background:#fff; align-self:flex-start; }
#sendForm { display:flex; border-top:1px solid #ccc; gap:5px; }
#messageInput { flex:1; border:none; padding:10px; width: 200px; }
</style>
</head>
<body>
<header>
  <span>SISTEMA BENEDITO JR PROGRAMACAO</span>
  <button id="logoutBtn">Sair</button>
</header>

<div id="login-container">
  <h3>Login / Cadastro</h3>
  <input type="text" id="nameInput" placeholder="Nome">
  <input type="email" id="emailInput" placeholder="E-mail">
  <input type="password" id="passwordInput" placeholder="Senha">
  <select id="roleSelect">
    <option value="master">Master</option>
    <option value="gerente">Gerente</option>
    <option value="vendedor">Vendedor</option>
    <option value="cliente">Cliente</option>
  </select>
  <div id="vinculoDiv" style="display:none;">
    <label>Vincular a:</label>
    <select id="vinculoSelect" multiple></select>
  </div>
  <button id="signupBtn">Cadastrar</button>
  <button id="loginBtn">Entrar</button>
</div>

<div id="chat-container">
  <div style="display:flex; gap:5px;">
    <input type="text" id="searchInput" placeholder="Pesquisar contato...">
    <button id="searchBtn">Pesquisar</button>
  </div>
  <div id="userList"></div>
</div>

<div id="chatModal">
  <div id="chatBox">
    <div id="messages"></div>
    <form id="sendForm">
      <input id="messageInput" placeholder="Digite sua mensagem...">
      <input type="file" id="fileInput" accept="image/*,audio/*">
      <button type="submit">Enviar</button>
    </form>
  </div>
</div>

<audio id="notifySound" src="https://www.soundjay.com/button/sounds/button-16.mp3" preload="auto"></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, doc, setDoc, getDoc, getDocs, onSnapshot, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0dUhymi72gkug-oo0-xqqBEtgvlIgvY0",
  authDomain: "cursos-6f950.firebaseapp.com",
  projectId: "cursos-6f950",
  storageBucket: "cursos-6f950.appspot.com",
  messagingSenderId: "146131122545",
  appId: "1:146131122545:web:043f8207f457ad5b7f5ed0"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

const loginContainer = document.getElementById('login-container');
const chatContainer = document.getElementById('chat-container');
const userList = document.getElementById('userList');
const chatModal = document.getElementById('chatModal');
const messagesDiv = document.getElementById('messages');
const sendForm = document.getElementById('sendForm');
const messageInput = document.getElementById('messageInput');
const fileInput = document.getElementById('fileInput');
const searchInput = document.getElementById('searchInput');
const logoutBtn = document.getElementById('logoutBtn');
const searchBtn = document.getElementById('searchBtn');
const emailInput = document.getElementById('emailInput');
const passwordInput = document.getElementById('passwordInput');
const nameInput = document.getElementById('nameInput');
const roleSelect = document.getElementById('roleSelect');
const vinculoDiv = document.getElementById('vinculoDiv');
const vinculoSelect = document.getElementById('vinculoSelect');
const notifySound = document.getElementById('notifySound');

let currentUser = null;
let currentChatId = null;
let currentUserRole = null;
let unreadMessages = [];

roleSelect.onchange = async () => {
  const role = roleSelect.value;
  vinculoDiv.style.display = (role === "master") ? "none" : "block";
  vinculoSelect.innerHTML = "";
  const snapshot = await getDocs(collection(db,"users"));
  snapshot.forEach(docSnap => {
    const u = docSnap.data();
    const option = document.createElement("option");
    option.value = docSnap.id;
    option.textContent = u.email + " (" + u.funcao + ")";
    vinculoSelect.appendChild(option);
  });
};

document.getElementById('signupBtn').onclick = async () => {
  const name = nameInput.value.trim();
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  const role = roleSelect.value;
  const selectedVinculos = Array.from(vinculoSelect.selectedOptions).map(o=>o.value);
  if(!name||!email||!password) return alert("Preencha todos os campos!");
  try {
    const userCred = await createUserWithEmailAndPassword(auth,email,password);
    await setDoc(doc(db,"users",userCred.user.uid),{
      nome:name,email,funcao:role,vinculos:selectedVinculos,createdAt:Date.now()
    });

    // 🔹 Sincronizar vínculos bidirecionais
    if(role==="cliente"){
      for(const vid of selectedVinculos){
        const vRef=doc(db,"users",vid);
        await updateDoc(vRef,{vinculos:arrayUnion(userCred.user.uid)});
      }
    }
    if(role==="vendedor"){
      for(const cid of selectedVinculos){
        const cRef=doc(db,"users",cid);
        await updateDoc(cRef,{vinculos:arrayUnion(userCred.user.uid)});
      }
    }

    alert("Usuário cadastrado!");
  } catch(e){ alert(e.message); }
};

document.getElementById('loginBtn').onclick = async () => {
  const email = emailInput.value.trim();
  const password = passwordInput.value.trim();
  if(!email||!password) return alert("Preencha e-mail e senha!");
  try { await signInWithEmailAndPassword(auth,email,password); } 
  catch(e){ alert(e.message); }
};

logoutBtn.onclick=async()=>{ await signOut(auth); };

onAuthStateChanged(auth,async(user)=>{
  if(user){
    currentUser = user;
    loginContainer.style.display="none";
    chatContainer.style.display="block";
    const snap = await getDoc(doc(db,"users",user.uid));
    currentUserRole = snap.data().funcao;
    currentUser.vinculos = snap.data().vinculos || [];
    loadUsers();
    if(Notification.permission!=="granted") Notification.requestPermission();
  } else{
    loginContainer.style.display="block";
    chatContainer.style.display="none";
  }
});

async function loadUsers(){
  const snapshot = await getDocs(collection(db,"users"));
  userList.innerHTML="";
  snapshot.forEach(docSnap=>{
    if(docSnap.id===currentUser.uid) return;
    const user = docSnap.data();
    const uid = docSnap.id;
    let show=false;

    if(currentUserRole==="master") show=true;
    else if(currentUserRole==="gerente") show=currentUser.vinculos?.includes(uid) || user.funcao==="cliente";
    else if(currentUserRole==="vendedor") show=currentUser.vinculos?.includes(uid) || user.vinculos?.includes(currentUser.uid);
    else if(currentUserRole==="cliente") show=currentUser.vinculos?.includes(uid) || user.vinculos?.includes(currentUser.uid);

    if(show) addUserToList(uid,user);
  });
}

function addUserToList(uid,user){
  const userDiv=document.createElement("div");
  userDiv.className="user";
  userDiv.textContent=user.email;
  const badge=document.createElement("span");
  badge.className="badge";
  userDiv.appendChild(badge);

  const chatId=[currentUser.uid,uid].sort().join("_");
  const chatRef=doc(db,"chats",chatId);
  onSnapshot(chatRef,snap=>{
    if(snap.exists()){
      const msgs = snap.data().messages || [];
      const lastMsg = msgs[msgs.length-1];
      if(lastMsg && lastMsg.sender!==currentUser.uid){
        badge.style.display="inline-block";
        unreadMessages[chatId]=true;
        notifySound.play();
        if(Notification.permission==="granted"){
          new Notification("Nova mensagem de "+user.email,{
            body:lastMsg.type==="text"?lastMsg.content:(lastMsg.type==="image"?"Imagem 📷":"Áudio 🎵")
          });
        }
      }
    }
  });

  userDiv.onclick=()=>{ badge.style.display="none"; delete unreadMessages[chatId]; openChat(uid,user.email); };
  userList.appendChild(userDiv);
}

searchBtn.onclick=async ()=>{
  const term = searchInput.value.trim().toLowerCase();
  if(!term) return alert("Digite algo para pesquisar.");
  const snapshot = await getDocs(collection(db,"users"));
  userList.innerHTML="";
  snapshot.forEach(docSnap=>{
    const u = docSnap.data();
    if(u.email.toLowerCase()===term){
      let show=false;
      const uid=docSnap.id;
      if(currentUserRole==="master") show=true;
      else if(currentUserRole==="gerente") show=currentUser.vinculos?.includes(uid) || u.funcao==="cliente";
      else if(currentUserRole==="vendedor") show=currentUser.vinculos?.includes(uid) || u.vinculos?.includes(currentUser.uid);
      else if(currentUserRole==="cliente") show=currentUser.vinculos?.includes(uid) || u.vinculos?.includes(currentUser.uid);
      if(show) addUserToList(uid,u);
    }
  });
};

async function openChat(targetId,targetEmail){
  chatModal.style.display="flex";
  currentChatId=[currentUser.uid,targetId].sort().join("_");
  messagesDiv.innerHTML="";

  const chatRef=doc(db,"chats",currentChatId);
  const chatSnap=await getDoc(chatRef);
  if(!chatSnap.exists()) await setDoc(chatRef,{users:[currentUser.uid,targetId],messages:[]});

  onSnapshot(chatRef,(snap)=>{
    const data = snap.data();
    messagesDiv.innerHTML="";
    if(data?.messages){
      data.messages.forEach(msg=>{
        const div=document.createElement("div");
        div.className="msg "+(msg.sender===currentUser.uid?"sent":"received");
        if(msg.type==="text") div.textContent=msg.content;
        else if(msg.type==="image"){ const img=document.createElement("img"); img.src=msg.content; img.style.maxWidth="100%"; div.appendChild(img); }
        else if(msg.type==="audio"){ const audio=document.createElement("audio"); audio.src=msg.content; audio.controls=true; div.appendChild(audio); }
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    }
  });
}

sendForm.addEventListener("submit",async(e)=>{
  e.preventDefault();
  if(!currentChatId) return;
  const text=messageInput.value.trim();
  const file=fileInput.files[0];
  const chatRef=doc(db,"chats",currentChatId);

  if(file){
    const fileExt=file.type.startsWith("image/")?"jpg":"mp3";
    const fileRef=ref(storage, `chats/${currentChatId}/${Date.now()}.${fileExt}`);
    await uploadBytes(fileRef,file);
    const url=await getDownloadURL(fileRef);
    await updateDoc(chatRef,{messages: arrayUnion({ sender:currentUser.uid, type:file.type.startsWith("image/")?"image":"audio", content:url, timestamp:Date.now() })});
    fileInput.value="";
  }
  if(text) await updateDoc(chatRef,{messages: arrayUnion({ sender:currentUser.uid,type:"text",content:text,timestamp:Date.now() })});
  messageInput.value="";
});

window.onclick=(e)=>{ if(e.target===chatModal) chatModal.style.display="none"; };
</script>
</body>
    </html>
