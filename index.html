<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mini WhatsApp</title>
  <style>
    body { font-family: Arial; background: #f5f5f5; margin: 0; }
    #loginScreen, #chatScreen { display: none; padding: 20px; }
    #contacts div { padding: 10px; background: #fff; margin: 5px 0; border-radius: 8px; cursor: pointer; }
    #chatModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    #chatBox { background: #fff; width: 90%; max-width: 400px; border-radius: 10px; display: flex; flex-direction: column; height: 80%; }
    #messages { flex: 1; overflow-y: auto; padding: 10px; }
    .msg { margin: 4px 0; padding: 8px; border-radius: 10px; max-width: 70%; word-wrap: break-word; }
    .sent { background: #dcf8c6; align-self: flex-end; }
    .received { background: #e5e5ea; align-self: flex-start; }
    #inputArea { display: flex; padding: 10px; background: #f0f0f0; }
    #inputArea input { flex: 1; padding: 8px; border-radius: 20px; border: 1px solid #ccc; margin-right: 5px; }
    #inputArea button { border: none; background: #25d366; color: white; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; }
    #emojiPicker { display: none; position: absolute; bottom: 60px; background: #fff; border: 1px solid #ccc; border-radius: 8px; padding: 5px; }
    #emojiPicker span { font-size: 22px; cursor: pointer; margin: 3px; }
  </style>
</head>
<body>
  <div id="loginScreen">
    <h2>Mini WhatsApp - Login</h2>
    <input type="email" id="email" placeholder="Email"><br><br>
    <input type="password" id="password" placeholder="Senha"><br><br>
    <button id="loginBtn">Entrar</button>
    <button id="registerBtn">Cadastrar</button>
  </div>

  <div id="chatScreen">
    <h2>Bem-vindo, <span id="userEmail"></span></h2>
    <input type="text" id="search" placeholder="Pesquisar contato..."><br><br>
    <div id="contacts"></div>
    <button id="logoutBtn">Sair</button>
  </div>

  <div id="chatModal">
    <div id="chatBox">
      <div id="chatHeader" style="background:#075E54;color:#fff;padding:10px;border-radius:10px 10px 0 0;">
        <span id="chatName"></span>
        <button id="closeChat" style="float:right;background:#ff4444;border:none;color:white;border-radius:5px;">X</button>
      </div>
      <div id="messages"></div>
      <div id="emojiPicker"></div>
      <div id="inputArea">
        <button id="emojiBtn">😊</button>
        <input id="msgInput" placeholder="Digite uma mensagem">
        <input type="file" id="imgInput" accept="image/*" style="display:none;">
        <button id="imgBtn">📎</button>
        <button id="sendBtn">➤</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, updateDoc, arrayUnion, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC0dUhymi72gkug-oo0-xqqBEtgvlIgvY0",
      authDomain: "cursos-6f950.firebaseapp.com",
      projectId: "cursos-6f950",
      storageBucket: "cursos-6f950.appspot.com",
      messagingSenderId: "146131122545",
      appId: "1:146131122545:web:043f8207f457ad5b7f5ed0"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const loginScreen = document.getElementById("loginScreen");
    const chatScreen = document.getElementById("chatScreen");
    const emailEl = document.getElementById("email");
    const passEl = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const registerBtn = document.getElementById("registerBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const userEmailEl = document.getElementById("userEmail");
    const contactsDiv = document.getElementById("contacts");
    const searchEl = document.getElementById("search");
    const chatModal = document.getElementById("chatModal");
    const chatNameEl = document.getElementById("chatName");
    const closeChat = document.getElementById("closeChat");
    const msgInput = document.getElementById("msgInput");
    const sendBtn = document.getElementById("sendBtn");
    const imgBtn = document.getElementById("imgBtn");
    const imgInput = document.getElementById("imgInput");
    const emojiBtn = document.getElementById("emojiBtn");
    const emojiPicker = document.getElementById("emojiPicker");
    const messagesDiv = document.getElementById("messages");

    let currentUser = null;
    let selectedUser = null;
    let unsubscribeChat = null;

    const emojis = ["😀","😁","😂","🤣","😍","😎","😢","😡","👍","🙏","❤️"];
    emojis.forEach(e => {
      const span = document.createElement("span");
      span.textContent = e;
      span.onclick = () => { msgInput.value += e; emojiPicker.style.display = "none"; };
      emojiPicker.appendChild(span);
    });

    emojiBtn.onclick = () => {
      emojiPicker.style.display = emojiPicker.style.display === "none" ? "block" : "none";
    };

    imgBtn.onclick = () => imgInput.click();

    imgInput.onchange = async () => {
      const file = imgInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = async (e) => {
          await sendMessage("", e.target.result);
        };
        reader.readAsDataURL(file);
      }
    };

    registerBtn.onclick = async () => {
      try {
        const userCred = await createUserWithEmailAndPassword(auth, emailEl.value, passEl.value);
        await setDoc(doc(db, "users", userCred.user.uid), { email: userCred.user.email });
        alert("Usuário cadastrado com sucesso!");
      } catch (err) {
        alert(err.message);
      }
    };

    loginBtn.onclick = async () => {
      try {
        await signInWithEmailAndPassword(auth, emailEl.value, passEl.value);
      } catch (err) {
        alert(err.message);
      }
    };

    logoutBtn.onclick = () => signOut(auth);

    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        loginScreen.style.display = "none";
        chatScreen.style.display = "block";
        userEmailEl.textContent = user.email;
        loadContacts();
      } else {
        currentUser = null;
        chatScreen.style.display = "none";
        loginScreen.style.display = "block";
      }
    });

    async function loadContacts() {
      const snap = await getDocs(collection(db, "users"));
      contactsDiv.innerHTML = "";
      snap.forEach(docSnap => {
        const data = docSnap.data();
        if (data.email !== currentUser.email) {
          const div = document.createElement("div");
          div.textContent = data.email;
          div.onclick = () => openChat(docSnap.id, data.email);
          contactsDiv.appendChild(div);
        }
      });
    }

    function getChatId(uid1, uid2) {
      return [uid1, uid2].sort().join("_");
    }

    async function openChat(uid, email) {
      selectedUser = { uid, email };
      chatNameEl.textContent = email;
      chatModal.style.display = "flex";
      messagesDiv.innerHTML = "";

      if (unsubscribeChat) unsubscribeChat();

      const chatId = getChatId(currentUser.uid, uid);
      const chatRef = doc(db, "chats", chatId);

      const chatSnap = await getDoc(chatRef);
      if (!chatSnap.exists()) await setDoc(chatRef, { messages: [] });

      unsubscribeChat = onSnapshot(chatRef, (docSnap) => {
        const data = docSnap.data();
        renderMessages(data?.messages || []);
      });
    }

    function renderMessages(msgs) {
      messagesDiv.innerHTML = "";
      msgs.forEach(msg => {
        const div = document.createElement("div");
        div.classList.add("msg");
        div.classList.add(msg.from === currentUser.uid ? "sent" : "received");
        if (msg.image) {
          const img = document.createElement("img");
          img.src = msg.image;
          img.style.maxWidth = "150px";
          img.style.borderRadius = "8px";
          div.appendChild(img);
        }
        if (msg.text) {
          div.appendChild(document.createTextNode(msg.text));
        }
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    sendBtn.onclick = async () => {
      const text = msgInput.value.trim();
      if (text) await sendMessage(text);
      msgInput.value = "";
    };

    async function sendMessage(text = "", image = null) {
      if (!selectedUser) return;
      const chatId = getChatId(currentUser.uid, selectedUser.uid);
      const chatRef = doc(db, "chats", chatId);
      await updateDoc(chatRef, {
        messages: arrayUnion({
          from: currentUser.uid,
          text,
          image,
          timestamp: new Date().toISOString()
        })
      });
    }

    closeChat.onclick = () => chatModal.style.display = "none";
  </script>
</body>
  </html>
