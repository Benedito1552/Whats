<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mini WhatsApp</title>
<style>
body { font-family: Arial, sans-serif; background: #ece5dd; margin: 0; padding: 0; }
#login-screen, #chat-screen { max-width: 400px; margin: 60px auto; background: white; padding: 20px; border-radius: 10px; text-align: center; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
input { width: 90%; padding: 10px; margin: 10px 0; }
button { padding: 10px 20px; background: #25d366; color: white; border: none; border-radius: 6px; cursor: pointer; }
#contacts { background: #fff; border-radius: 10px; max-width: 400px; margin: 10px auto; padding: 10px; }
.contact { padding: 10px; border-bottom: 1px solid #ddd; cursor: pointer; }
.contact-container { display: flex; align-items: center; justify-content: space-between; }
.contact-avatar { width: 30px; height: 30px; border-radius: 50%; display: inline-block; margin-right: 10px; vertical-align: middle; background-color: gray; text-align: center; line-height: 30px; color: white; font-weight: bold; font-size: 14px; }
.contact-name { vertical-align: middle; }
.notification { position: absolute; right: 10px; top: 10px; width: 12px; height: 12px; background: red; border-radius: 50%; }
.modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
.modal-content { background: #fff; border-radius: 10px; width: 90%; max-width: 400px; margin: 50px auto; padding: 10px; position: relative; display: flex; flex-direction: column; height: 70%; }
.close { position: absolute; right: 15px; top: 10px; font-size: 22px; cursor: pointer; }
#messages { flex: 1; overflow-y: auto; padding: 10px; border: 1px solid #ddd; background: #f9f9f9; }
.message { margin: 5px; padding: 8px 12px; border-radius: 15px; max-width: 75%; clear: both; }
.sent { background: #dcf8c6; align-self: flex-end; float: right; }
.received { background: #fff; float: left; }
#message-input { width: 70%; padding: 10px; }
#send-btn { width: 25%; }
#search-contacts { width: 90%; padding: 8px; margin: 10px 0; border-radius: 5px; border: 1px solid #ccc; }
</style>
</head>
<body>
<!-- Login -->
<div id="login-screen">
  <h2>Entrar</h2>
  <input id="email" placeholder="Email"><br>
  <input id="password" type="password" placeholder="Senha"><br>
  <button id="login-btn">Entrar</button>
  <button id="register-btn">Cadastrar</button>
</div>

<!-- Chat -->
<div id="chat-screen" style="display:none;">
  <h3>Conectado como: <span id="user-name"></span></h3>
  <button id="logout-btn">Sair</button>
  <input id="search-contacts" placeholder="Pesquisar contato...">
  <div id="contacts"></div>
</div>

<!-- Modal de Chat -->
<div id="chat-modal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="chat-header">Chat</h3>
    <div id="messages"></div>
    <div style="margin-top:10px;">
      <input id="message-input" placeholder="Digite uma mensagem...">
      <button id="send-btn">Enviar</button>
    </div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc, getDocs, setDoc, updateDoc, arrayUnion, onSnapshot, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC0dUhymi72gkug-oo0-xqqBEtgvlIgvY0",
  authDomain: "cursos-6f950.firebaseapp.com",
  projectId: "cursos-6f950",
  storageBucket: "cursos-6f950.firebasestorage.app",
  messagingSenderId: "146131122545",
  appId: "1:146131122545:web:043f8207f457ad5b7f5ed0"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let selectedContact = null;
let unsubscribeMessages = null;

const loginScreen = document.getElementById("login-screen");
const chatScreen = document.getElementById("chat-screen");
const contactsDiv = document.getElementById("contacts");
const messagesDiv = document.getElementById("messages");
const chatHeader = document.getElementById("chat-header");
const emailInput = document.getElementById("email");
const passwordInput = document.getElementById("password");
const loginBtn = document.getElementById("login-btn");
const registerBtn = document.getElementById("register-btn");
const logoutBtn = document.getElementById("logout-btn");
const sendBtn = document.getElementById("send-btn");
const msgInput = document.getElementById("message-input");
const userNameEl = document.getElementById("user-name");
const chatModal = document.getElementById("chat-modal");
const closeModal = document.querySelector(".close");
const searchInput = document.getElementById("search-contacts");

// === Cadastro/Login/Logout ===
registerBtn.onclick = async () => {
  try {
    const userCred = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
    await setDoc(doc(db, "users", userCred.user.uid), { email: userCred.user.email, uid: userCred.user.uid, createdAt: new Date() });
    alert("Usuário cadastrado com sucesso!");
  } catch (err) { alert(err.message); }
};
loginBtn.onclick = async () => { try { await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value); } catch (err) { alert(err.message); } };
logoutBtn.onclick = async () => { await signOut(auth); };

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    loginScreen.style.display = "none";
    chatScreen.style.display = "block";
    userNameEl.textContent = user.email;
    loadContacts();
  } else {
    currentUser = null;
    chatScreen.style.display = "none";
    loginScreen.style.display = "block";
  }
});

// === Carregar contatos com avatar e notificação ===
async function loadContacts() {
  const snapshot = await getDocs(collection(db, "users"));
  contactsDiv.innerHTML = "";
  snapshot.forEach(docSnap => {
    const user = docSnap.data();
    if (user.email !== currentUser.email) {

      const div = document.createElement("div");
      div.classList.add("contact");

      const container = document.createElement("div");
      container.classList.add("contact-container");

      const avatar = document.createElement("div");
      avatar.classList.add("contact-avatar");
      avatar.textContent = user.email[0].toUpperCase();
      avatar.style.backgroundColor = stringToColor(user.email);

      const name = document.createElement("span");
      name.classList.add("contact-name");
      name.textContent = user.email;

      const notif = document.createElement("span");
      notif.classList.add("notification");
      notif.style.display = "none";

      container.appendChild(avatar);
      container.appendChild(name);
      container.appendChild(notif);
      div.appendChild(container);
      div.dataset.uid = user.uid;

      div.onclick = () => openChatModal(user, div);
      contactsDiv.appendChild(div);

      monitorUnreadMessages(user.uid, notif, user.email);
    }
  });
}

// === Monitorar mensagens para notificação ===
function monitorUnreadMessages(otherUid, notifEl, otherEmail) {
  const chatId = getChatId(currentUser.uid, otherUid);
  const chatRef = doc(db, "chats", chatId);

  onSnapshot(chatRef, (docSnap) => {
    if (!docSnap.exists()) return;
    const msgs = docSnap.data().messages || [];
    const unreadMsgs = msgs.filter(m => m.from === otherUid);

    notifEl.style.display = (unreadMsgs.length && (!selectedContact || selectedContact.uid !== otherUid)) ? "inline-block" : "none";

    if (unreadMsgs.length && (!selectedContact || selectedContact.uid !== otherUid)) {
      if ("Notification" in window && Notification.permission === "granted") {
        const lastMsg = unreadMsgs[unreadMsgs.length - 1].text;
        const preview = lastMsg.length > 50 ? lastMsg.substring(0, 50) + "…" : lastMsg;
        new Notification("Nova mensagem de " + otherEmail, { body: preview, icon: "https://cdn-icons-png.flaticon.com/512/124/124034.png" });
      }
    }
  });
}

// === Abrir chat modal ===
function openChatModal(user, contactDiv) {
  selectedContact = user;
  chatHeader.textContent = "Conversando com: " + user.email;
  chatModal.style.display = "block";
  messagesDiv.innerHTML = "";
  contactDiv.querySelector(".notification").style.display = "none";
  listenMessages(user);
}

closeModal.onclick = () => { chatModal.style.display = "none"; if (unsubscribeMessages) unsubscribeMessages(); selectedContact = null; };
window.onclick = (event) => { if (event.target === chatModal) { chatModal.style.display = "none"; if (unsubscribeMessages) unsubscribeMessages(); selectedContact = null; } };

// === Escutar mensagens em tempo real ===
function listenMessages(user) {
  if (unsubscribeMessages) unsubscribeMessages();
  const chatId = getChatId(currentUser.uid, user.uid);
  const chatRef = doc(db, "chats", chatId);

  unsubscribeMessages = onSnapshot(chatRef, docSnap => {
    messagesDiv.innerHTML = "";
    if (!docSnap.exists()) return;
    const msgs = docSnap.data().messages || [];
    msgs.forEach(msg => {
      const div = document.createElement("div");
      div.classList.add("message");
      div.classList.add(msg.from === currentUser.uid ? "sent" : "received");
      div.textContent = msg.text;
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  });
}

// === Enviar mensagem ===
sendBtn.onclick = async () => {
  if (!selectedContact) return alert("Selecione um contato primeiro!");
  const text = msgInput.value.trim();
  if (!text) return;

  const chatId = getChatId(currentUser.uid, selectedContact.uid);
  const chatRef = doc(db, "chats", chatId);

  const chatSnap = await getDoc(chatRef);
  if (!chatSnap.exists()) await setDoc(chatRef, { messages: [] });

  await updateDoc(chatRef, { messages: arrayUnion({ from: currentUser.uid, text, timestamp: new Date() }) });
  msgInput.value = "";
};

// === Funções utilitárias ===
function getChatId(uid1, uid2) { return [uid1, uid2].sort().join("_"); }
function stringToColor(str) { let hash = 0; for (let i=0;i<str.length;i++) hash = str.charCodeAt(i) + ((hash<<5)-hash); let color="#"; for(let i=0;i<3;i++){ const val=(hash>>(i*8))&0xFF; color+=('00'+val.toString(16)).substr(-2);} return color; }

// === Pesquisa de contatos ===
searchInput.addEventListener("input", () => {
  const filter = searchInput.value.toLowerCase();
  const contactDivs = contactsDiv.querySelectorAll(".contact");
  contactDivs.forEach(div => {
    const name = div.querySelector(".contact-name").textContent.toLowerCase();
    div.style.display = name.includes(filter) ? "flex" : "none";
  });
});

// === Solicitar permissão para notificações ===
if ("Notification" in window && Notification.permission !== "granted") Notification.requestPermission();
</script>
</body>
  </html>
